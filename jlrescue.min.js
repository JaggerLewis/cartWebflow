let timer,tracksLog,icon,markers=[];const switchBtn=(a,b)=>{let c=document.getElementById(a),d=c.cloneNode(!0);return d.addEventListener("click",()=>b()),c.parentElement.appendChild(d),c.remove(),d},startRescue=async a=>{updateLoading(2),loaderContainer.style.display="flex";let b={activity_id:"rescue",start_timestamp:Date.now(),aside_data:JSON.stringify({mode:"standard_follow"}),dog_id:dog._id},c=await fetch(`https://app-api.mypet.fit/personal_activity`,{method:"PUT",headers:header,body:JSON.stringify(b)}).then(async a=>await a.json()),d=c.timestamp_key;c=await fetch(`https://app-api.mypet.fit/collar/${dog.collar.simcardID}/rescue`,{method:"POST",headers:header,body:JSON.stringify({mode:"standard_follow",key:d})}).then(async a=>await a.json()),a.innerHTML=getTrad("Arr\xEAter la g\xE9olocalisation","Stop geolocation"),switchBtn("jl-rescue-action",()=>stopRescue(d)),circle?.setMap(map),loaderContainer.style.display="none",document.getElementById("jag-detail-activity").style.display="none",document.getElementById("jag-detail-rescue").style.display="flex",timer=setInterval(()=>{tracks(d)},5e3)},tracks=async a=>{let b,c=2,d=await fetch(`https://app-api.mypet.fit/personal_activity/${dog.collar.simcardID}/${a}/rescue/tracks`,{method:"GET",headers:header}).then(async a=>await a?.json());return clearMap(),d&&map||stopRescue(),icon||(icon={url:"https://assets-global.website-files.com/6549f4ba8294cf140608d893/664e065a96ae535c2291cf88_dog%20pict.png",scaledSize:new google.maps.Size(50,50),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,0)}),"GNSS_TIMEOUT"==d.Tracks[d.Tracks.lenght-1]?.origin_mode?(await circle.setMap(null),c=6,circle.fillColor="red",circle.strokeColor="red",void circle.setMap(map)):void(d.Tracks.find(a=>1==a.tracking_cmd)?(c=4,d.Tracks.reverse().forEach(a=>{if(0!=a.tracking_cmd){b={lat:a.lat,lng:a.lon},c=4,circle.setMap(null);let d=new google.maps.Marker({map:map,position:b,title:"",icon:icon??`https://assets-global.website-files.com/6549f4ba8294cf140608d893/664c893a5d2b02d82784dbdc_imagedog.png`});markers.push(d)}})):d.Tracks.find(a=>0==a.tracking_cmd)?(await circle.setMap(null),c=3,circle.fillColor="#5363ff",circle.strokeColor="#5363ff",circle.setMap(map)):circle.setMap(map),updateLoading(c),map.setCenter(b))},updateLoading=a=>{const b=a=>c.forEach((b,c)=>b.style.backgroundColor=c==a?"#5363ff":"rgba(0, 0, 0, .07)");let c=document.querySelectorAll("[id^='jag-rescue-info-path']"),d=document.getElementById("jag-rescue-info-title"),e=document.getElementById("jag-rescue-info-description");switch(a){case 2:b(1),d.innerHTML=getTrad("Demande de localisation envoy\xE9e","Location request sent"),e.innerHTML=getTrad("Nous contactons votre collier, cela peut prendre du temps s'il se trouve dans une zone \xE0 faible couverture r\xE9seau...","We will contact your collar, which may take some time if it is in an area with poor network coverage...");break;case 3:b(2),d.innerHTML=getTrad("Bo\xEEtier contact\xE9, localisation en cours","Collar contacted, location in progress"),e.innerHTML=getTrad("Votre chien se trouve dans cette zone, nous recherchons actuellement un position plus pr\xE9cise.","Your dog is in this area. We are currently looking for a more precise location.");break;case 4:b(3),d.innerHTML=getTrad("Bo\xEEtier localis\xE9","Localized collar"),e.innerHTML=dog.name+getTrad("est actuellement localis\xE9 \xE0 cette position","is currently located at this position.");break;case 5:b(4),d.innerHTML=getTrad("Arr\xEAte en cours","Stop in progress"),e.innerHTML=getTrad("Nous contactons le bo\xEEtier afin d'arr\xEAter la localisation","We contact the collar to stop the location");break;case 6:b(-1),d.innerHTML=dog.name+getTrad("est introuvable...","connot be found..."),e.innerHTML=getTrad(`Nous continuons de rechercher ${dog.name}, mais cela prends plus de temps que prÃ©vu`,`We're still searching for ${dog.name}, but it's taking longer than expected`);break;default:b(0),d.innerHTML=getTrad("Recherche de l'antenne","Antenna search"),e.innerHTML=getTrad("Avant de contacter votre bo\xEEtier, nous localison la zone gr\xE2ce \xE0 l'antenne r\xE9seau la plus proche","Before contacting your collar, we locate the area using the nearest network antenna")}},clearMap=()=>{path&&path.setMap(null),circle&&circle.setMap(null),markers.forEach(a=>{a.setMap(null)}),markers=[]},stopRescue=async a=>{updateLoading(5),clearInterval(timer);let b=await fetch(`https://app-api.mypet.fit/collar/${dog.collar.simcardID}/rescue`,{method:"POST",headers:header,body:JSON.stringify({mode:"stop_follow",key:a})}).then(async a=>await a.json()),c=switchBtn("jl-rescue-action",()=>initRescue(document.getElementById("jl-rescue-action")));c.innerHTML=getTrad("Lancer une localisation","Start a search"),updateLoading(0),clearMap(),initMap(document.getElementById("jl-map"),!0)},initRescue=async a=>{updateLoading(1),await getDog(dog._id);let b=dog.personalActivities.find(a=>!a.end_timestamp);if(!b)a.innerHTML=getTrad("Lancer une localisation","Start a search"),a.addEventListener("click",()=>startRescue(a));else if("rescue"==b.type){let a=switchBtn("jl-rescue-action",()=>stopRescue(b.timestamp_key));updateLoading(2),a.innerHTML=getTrad("Arr\xEAter la g\xE9olocalisation","Stop geolocation"),timer=setInterval(()=>{tracks(b.timestamp_key)},1e3)}else"activity"==b.type&&(a.parentElement.style.backgroundColor="grey",a.addEventListener("click",()=>showAddCart(getTrad("Une activit\xE9 est d\xE9j\xE0 en cours !","One activity is already underway!"))))};